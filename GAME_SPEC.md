# 黒焔の迷宮 - ゲーム仕様書

**最終更新**: 2025年2月7日
**バージョン**: v0.5.0
**開発体制**: Agent Team（厳格レビュー体制）

---

## 📖 目次

1. [基本情報](#基本情報)
2. [ゲームプレイ](#ゲームプレイ)
3. [操作方法](#操作方法)
4. [システム仕様](#システム仕様)
5. [技術仕様](#技術仕様)
6. [実装状況](#実装状況)
7. [既知の問題](#既知の問題)
8. [改善予定](#改善予定)
9. [変更履歴](#変更履歴)

---

## 基本情報

### ゲームタイトル
**黒焔の迷宮 (Diablo Style Hack & Slash)**

### ジャンル
- ハック＆スラッシュ RPG
- ローグライク要素
- トップダウン視点

### コンセプト
- Diabloライクな暗黒ファンタジー
- 敵を蹴散らす爽快感重視
- スキルカスタマイズの自由度
- プロシージャル生成ダンジョン

### プラットフォーム
- ブラウザゲーム（HTML5 Canvas）
- デスクトップブラウザ推奨

---

## ゲームプレイ

### 目標
ダンジョンの深層を目指して、モンスターを倒しながら階層を降りていく

### ゲームフロー
1. **キャラクター選択**
   - 戦士 / ローグ / ソーサラー から選択
   - 各クラスで基礎ステータスとスキルツリーが異なる

2. **ダンジョン探索**
   - プロシージャル生成された60x60マップ
   - 敵を倒してレベルアップ
   - アイテムを収集・装備

3. **階層移動**
   - 階段を見つけて次の階層へ（Eキー）
   - 5階層ごとにボス出現

4. **死亡とリスタート**
   - 死亡時は1階層前に復活
   - HP/MP全回復

### ハック＆スラッシュ要素
- **大量の敵**: Floor 1で23体、継続的にリスポーン
- **爽快な移動**: 慣性システムでキビキビ動く
- **スキルコンボ**: 6つのスキルを自由に設定
- **アイテムドロップ**: レアリティ別のランダム装備

---

## 操作方法

### 基本操作
| キー | 機能 |
|-----|------|
| **矢印キー** | 移動（8方向） |
| **マウスクリック** | 目標地点へ移動 |
| **スペースキー** | 近くのアイテムを拾う |
| **1～6キー** | スキル発動 |

### UI操作
| キー | 機能 |
|-----|------|
| **C** | ステータス画面 開閉 |
| **I** | インベントリ 開閉 |
| **T** | スキルツリー 開閉 |
| **R** | スキルショートカット編集 |
| **H** | ヘルプ画面 開閉 |
| **O** | 設定画面 開閉 |
| **E** | 階段を降りる |
| **Esc** | ポーズ / 閉じる |
| **F5** | セーブ |
| **F8** | ロード |

### 特殊操作
| キー | 機能 |
|-----|------|
| **G** | 自動拾い 切り替え |
| **P** | 拾うアイテムのレアリティフィルター |

---

## システム仕様

### キャラクター

#### ステータス
- **HP (体力)**: 0になると死亡
- **MP (マナ)**: スキル使用に消費
- **STR (力)**: 攻撃力に影響
- **DEX (敏捷)**: クリティカル率・回避に影響
- **VIT (体力)**: 最大HP・防御力に影響
- **INT (知力)**: 最大MP・スキル威力に影響

#### 成長システム
- **経験値**: 敵を倒すと獲得
- **レベルアップ**: ステータスポイント+3、スキルポイント+1
- **ステータスポイント**: STR/DEX/VIT/INTを強化
- **スキルポイント**: スキルツリーでスキル習得

### クラス

#### 戦士 (Warrior)
- **特徴**: 高HP、近接攻撃特化
- **基礎ステータス**: STR 15, DEX 8, VIT 12, INT 5

#### ローグ (Rogue)
- **特徴**: 高機動、クリティカル特化
- **基礎ステータス**: STR 8, DEX 15, VIT 8, INT 9

#### ソーサラー (Sorcerer)
- **特徴**: 高火力魔法、遠距離攻撃
- **基礎ステータス**: STR 5, DEX 8, VIT 7, INT 20

### スキルシステム

#### スキルスロット
- **6スロット**: 1～6キーに対応
- **初期状態**: 空（プレイヤーが自分で設定）
- **設定方法**:
  1. Tキー → スキルツリーで習得
  2. 「スロットに設定」ボタン or Rキーで編集

#### スキルツリー
- **3ブランチ**: 各クラスごとに特色あるスキル
- **スキルレベル**: 各スキルLv.1～5まで強化可能
- **前提スキル**: 一部スキルは前提スキルの習得が必要

#### スキル編集（Rキー）
- **設定モード**: スロット選択 → スキル選択
- **入れ替えモード**: スロット間でスキルを入れ替え
- **削除**: スロット選択 → 「スロットを空にする」ボタン
- **ドラッグ&ドロップ**: スロットをドラッグして入れ替え
- **死亡時も編集可能**: 死亡画面でもRキーで編集できる

### アイテムシステム

#### レアリティ
- **Common (白)**: 基本性能のみ
- **Magic (青)**: +1 Affix
- **Rare (黄)**: +2 Affixes
- **Legendary (橙)**: +3 Affixes、強力
- **Unique (緑)**: 特殊効果

#### 装備スロット
- Weapon（武器）
- Offhand（盾・副武器）
- Head（頭）
- Body（体）
- Ring（指輪）
- Amulet（首飾り）
- Feet（靴）

#### Affix（追加効果）
- ダメージ増加
- 防御力増加
- ステータス増加
- クリティカル率増加
- など

### ダンジョン

#### マップ生成
- **サイズ**: 60x60 タイル（1タイル = 40px）
- **生成方式**: プロシージャル生成（BSP法）
- **部屋数**: 8～15部屋
- **廊下**: 部屋を接続

#### 敵出現
- **初期出現**: `15 + Floor * 8` 体
- **継続リスポーン**: 8秒ごとに3体追加
- **最大数**: `30 + Floor * 5` 体
- **ボス**: 5階層ごとに1体

#### アイテム
- **宝箱**: 各階層に1～3個
- **ドロップ**: 敵を倒すと確率でドロップ

---

## 技術仕様

### 使用技術
- **HTML5 Canvas API**: 描画
- **Vanilla JavaScript (ES6+)**: ゲームロジック
- **Web Audio API**: サウンド（プロシージャル生成）
- **localStorage**: セーブデータ保存

### ファイル構成
```
Diablotest/
├── diablo_game.html     # メインゲームファイル（6470行）
├── GAME_SPEC.md         # ゲーム仕様書（本ファイル）
├── TEAM_SPEC.md         # チーム仕様書
└── .git/                # Gitリポジトリ
```

### パフォーマンス最適化
- **パーティクル上限**: 500個
- **デルタタイム上限**: 0.05秒（20FPS保証）
- **視野外カリング**: 画面外の敵は簡易処理
- **タイルキャッシュ**: オフスクリーンキャンバスで事前生成

### ブラウザ互換性
- **推奨**: Chrome 90+, Firefox 88+, Safari 14+
- **DPR対応**: Retina対応（上限2倍）
- **モバイル**: 非推奨（操作性の問題）

---

## 実装状況

### ✅ 実装済み機能

#### コアシステム
- ✅ プレイヤー移動（慣性システム）
- ✅ 敵AI（追跡、攻撃）
- ✅ 衝突判定（8方向）
- ✅ ダンジョン生成
- ✅ 敵リスポーンシステム

#### スキルシステム
- ✅ スキルツリー（3ブランチ×複数スキル）
- ✅ スキルスロット編集（Rキー）
- ✅ スキル削除機能
- ✅ スキルツリーから直接設定
- ✅ 死亡時もスキル編集可能

#### アイテムシステム
- ✅ レアリティシステム
- ✅ Affix生成
- ✅ インベントリ（24スロット）
- ✅ 装備変更
- ✅ 自動拾い機能

#### UI/UX
- ✅ HP/MPオーブ（Diablo風）
- ✅ スキルバー（6スロット）
- ✅ ステータス画面
- ✅ インベントリ画面
- ✅ スキルツリー画面
- ✅ ヘルプ画面
- ✅ 設定画面

#### セーブシステム
- ✅ 3つのセーブスロット
- ✅ オートセーブ（階層移動時）
- ✅ 手動セーブ（F5）

### 🚧 未実装・改善予定

#### グラフィック
- ❌ キャラクターアニメーション（歩行、攻撃）
- ❌ 敵アニメーション
- ❌ 攻撃エフェクト強化（スラッシュ軌跡）
- ❌ 動的ライティング
- ❌ ミニマップ

#### ゲームプレイ
- ❌ ダッシュ/回避システム
- ❌ クラス昇格システム（実装途中）
- ❌ エンドコンテンツ

#### UI
- ❌ バフ/デバフ表示
- ❌ フローティングダメージ（改善）
- ❌ ボスHPバー

---

## 既知の問題

### 🐛 バグ
現在、既知の重大バグはありません。

### ⚠️ 制限事項
- モバイル非対応（タッチ操作未実装）
- セーブデータ容量制限（localStorage: 5-10MB）
- ブラウザキャッシュ問題（強制リロード必要な場合あり）

---

## 改善予定

### 優先度：高
1. キャラクター歩行アニメーション
2. 攻撃エフェクト強化
3. ミニマップ実装

### 優先度：中
4. 動的ライティング
5. ダッシュ/回避システム
6. バフ/デバフUI

### 優先度：低
7. モバイル対応
8. マルチプレイヤー要素
9. サウンドトラック追加

---

## 変更履歴

### v0.5.0 (2025-02-07)
**主な変更**:
- ✅ スキルスロット初期化を空に変更
- ✅ スキル削除機能追加
- ✅ スキルツリーから直接設定可能に
- ✅ 移動慣性調整（ハクスラ感強化）
- ✅ 敵出現数3倍に増加（15 + Floor*8）
- ✅ 敵の継続リスポーンシステム追加
- ✅ Rキーが死亡時も動作するよう修正
- ✅ Division by Zero バグ修正
- ✅ パーティクル上限設定（500個）

**修正されたバグ**:
- 重複keydownイベントリスナーによるRキー不動作
- 復活後に全キーが効かなくなる致命的バグ
- 未習得スキルがスロットに入るバグ

**レビュー体制**:
- Agent Team厳格レビュー体制を導入

### v0.4.0 (初期リリース)
- 基本的なゲームシステム実装
- プレイヤー移動、戦闘、スキル
- アイテム、ダンジョン生成

---

## 開発体制

本ゲームは **Agent Team 厳格レビュー体制** で開発されています。

詳細は [TEAM_SPEC.md](TEAM_SPEC.md) を参照してください。

---

**End of Document**
