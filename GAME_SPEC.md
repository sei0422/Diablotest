# 黒焔の迷宮 - ゲーム仕様書

**最終更新**: 2026年2月8日
**バージョン**: v0.6.0
**開発体制**: Agent Team（厳格レビュー体制）

---

## 📖 目次

1. [基本情報](#基本情報)
2. [ゲームプレイ](#ゲームプレイ)
3. [操作方法](#操作方法)
4. [システム仕様](#システム仕様)
5. [技術仕様](#技術仕様)
6. [エフェクトシステム](#エフェクトシステム)
7. [実装状況](#実装状況)
8. [既知の問題](#既知の問題)
9. [改善予定](#改善予定)
10. [変更履歴](#変更履歴)

---

## 基本情報

### ゲームタイトル
**黒焔の迷宮 (Diablo Style Hack & Slash)**

### ジャンル
- ハック＆スラッシュ RPG
- ローグライク要素
- トップダウン視点

### コンセプト
- Diabloライクな暗黒ファンタジー
- 敵を蹴散らす爽快感重視
- スキルカスタマイズの自由度
- プロシージャル生成ダンジョン
- 派手なビジュアルエフェクト

### プラットフォーム
- ブラウザゲーム（HTML5 Canvas）
- デスクトップブラウザ推奨

---

## ゲームプレイ

### 目標
ダンジョンの深層を目指して、モンスターを倒しながら階層を降りていく

### ゲームフロー
1. **キャラクター選択**
   - 戦士 / ローグ / ソーサラー から選択
   - 各クラスで基礎ステータスとスキルツリーが異なる

2. **ダンジョン探索**
   - プロシージャル生成された60x60マップ
   - 敵を倒してレベルアップ
   - アイテムを収集・装備

3. **階層移動**
   - 階段を見つけて次の階層へ（Eキー）
   - 5階層ごとにボス出現

4. **死亡とリスタート**
   - 死亡時は1階層前に復活
   - HP/MP全回復

### ハック＆スラッシュ要素
- **大量の敵**: Floor 1で23体、継続的にリスポーン
- **爽快な移動**: 慣性システムでキビキビ動く
- **スキルコンボ**: 6つのスキルを自由に設定
- **アイテムドロップ**: レアリティ別のランダム装備
- **派手なエフェクト**: Diablo風の大量パーティクル

---

## 操作方法

### 基本操作
| キー | 機能 |
|-----|------|
| **矢印キー** | 移動（8方向） |
| **マウスクリック** | 目標地点へ移動 |
| **スペースキー** | 近くのアイテムを拾う |
| **1～6キー** | スキル即時発動（自動ターゲット） |

### UI操作
| キー | 機能 |
|-----|------|
| **C** | ステータス画面 開閉 |
| **I** | インベントリ 開閉 |
| **T** | スキルツリー 開閉 |
| **R** | スキルショートカット編集 |
| **H** | ヘルプ画面 開閉 |
| **O** | 設定画面 開閉 |
| **E** | 階段を降りる |
| **Esc** | ポーズ / 閉じる |
| **F5** | セーブ |
| **F8** | ロード |

### 特殊操作
| キー | 機能 |
|-----|------|
| **G** | 自動拾い 切り替え |
| **P** | 拾うアイテムのレアリティフィルター |

---

## システム仕様

### キャラクター

#### ステータス
- **HP (体力)**: 0になると死亡
- **MP (マナ)**: スキル使用に消費
- **STR (力)**: 攻撃力に影響
- **DEX (敏捷)**: クリティカル率・回避に影響
- **VIT (体力)**: 最大HP・防御力に影響
- **INT (知力)**: 最大MP・スキル威力に影響

#### 成長システム
- **経験値**: 敵を倒すと獲得
- **レベルアップ**: ステータスポイント+3、スキルポイント+1
- **ステータスポイント**: STR/DEX/VIT/INTを強化
- **スキルポイント**: スキルツリーでスキル習得

### クラス

#### 戦士 (Warrior)
- **特徴**: 高HP、近接攻撃特化
- **基礎ステータス**: STR 15, DEX 8, VIT 12, INT 5

#### ローグ (Rogue)
- **特徴**: 高機動、クリティカル特化
- **基礎ステータス**: STR 8, DEX 15, VIT 8, INT 9

#### ソーサラー (Sorcerer)
- **特徴**: 高火力魔法、遠距離攻撃
- **基礎ステータス**: STR 5, DEX 8, VIT 7, INT 20

### スキルシステム

#### スキルスロット
- **6スロット**: 1～6キーに対応
- **初期状態**: 空（プレイヤーが自分で設定）
- **即時発動**: 数字キーを押すだけでスキル発動（自動ターゲット）
- **設定方法**:
  1. Tキー → スキルツリーで習得
  2. 「スロットに設定」ボタン or Rキーで編集

#### スキルツリー
- **3ブランチ**: 各クラスごとに特色あるスキル
- **スキルレベル**: 各スキルLv.1～5まで強化可能
- **前提スキル**: 一部スキルは前提スキルの習得が必要

#### スキル編集（Rキー）
- **設定モード**: スロット選択 → スキル選択
- **入れ替えモード**: スロット間でスキルを入れ替え
- **削除**: スロット選択 → 「スロットを空にする」ボタン
- **ドラッグ&ドロップ**: スロットをドラッグして入れ替え
- **死亡時も編集可能**: 死亡画面でもRキーで編集できる

### アイテムシステム

#### レアリティ
- **Common (白)**: 基本性能のみ
- **Magic (青)**: +1 Affix
- **Rare (黄)**: +2 Affixes
- **Legendary (橙)**: +3 Affixes、強力
- **Unique (緑)**: 特殊効果

#### 装備スロット
- Weapon（武器）
- Offhand（盾・副武器）
- Head（頭）
- Body（体）
- Ring（指輪）
- Amulet（首飾り）
- Feet（靴）

#### Affix（追加効果）
- ダメージ増加
- 防御力増加
- ステータス増加
- クリティカル率増加
- など

### ダンジョン

#### マップ生成
- **サイズ**: 60x60 タイル（1タイル = 40px）
- **生成方式**: プロシージャル生成（BSP法）
- **部屋数**: 8～15部屋
- **廊下**: 部屋を接続

#### 敵出現
- **初期出現**: `15 + Floor * 8` 体
- **継続リスポーン**: 8秒ごとに3体追加
- **最大数**: `30 + Floor * 5` 体
- **ボス**: 5階層ごとに1体

#### アイテム
- **宝箱**: 各階層に1～3個
- **ドロップ**: 敵を倒すと確率でドロップ

---

## 技術仕様

### 使用技術
- **HTML5 Canvas API**: 描画
- **Vanilla JavaScript (ES6+)**: ゲームロジック
- **Web Audio API**: サウンド（プロシージャル生成）
- **localStorage**: セーブデータ保存

### ファイル構成
```
Diablotest/
├── diablo_game.html     # メインゲームファイル（6800+行）
├── GAME_SPEC.md         # ゲーム仕様書（本ファイル）
├── TEAM_SPEC.md         # チーム仕様書
├── CLASS_ROADMAP.md     # クラス進化ロードマップ
└── .git/                # Gitリポジトリ
```

### パフォーマンス最適化
- **パーティクル上限**: 1500個（Diabloモード）、500個（低負荷モード）
- **Diabloモード**: パーティクル数を3倍に増幅（デフォルト有効）
- **デルタタイム上限**: 0.05秒（20FPS保証）
- **視野外カリング**: 画面外の敵は簡易処理
- **タイルキャッシュ**: オフスクリーンキャンバスで事前生成

### ブラウザ互換性
- **推奨**: Chrome 90+, Firefox 88+, Safari 14+
- **DPR対応**: Retina対応（上限2倍）
- **モバイル**: 非推奨（操作性の問題）

---

## エフェクトシステム

### 属性システム
全てのスキルエフェクトは7つの属性に分類されます：

#### 🔥 Fire（火炎）
- **動作**: 上昇+ちらつき、拡散
- **色**: オレンジ（#ff6600）
- **特徴**: 上向きに舞い上がる炎のパーティクル

#### ❄️ Ice（氷結）
- **動作**: 減速+回転、外側に広がる
- **色**: シアン（#88ddff）
- **形状**: ダイヤモンド形状
- **特徴**: 結晶状のパーティクルが回転しながら広がる

#### ⚡ Lightning（雷）
- **動作**: ジグザグ、高速、軌跡
- **色**: 青白（#88ccff）
- **特徴**: ランダムな方向転換、残像効果

#### 💥 Physical（物理）
- **動作**: 重力+バウンス、破片状
- **色**: 茶色がかったオレンジ（#ffaa44）
- **特徴**: 打撃の衝撃による破片飛散

#### ✨ Holy（神聖）
- **動作**: 放射状爆発、柔らかい光、降下
- **色**: ゴールド（#ffdd88）
- **特徴**: 聖なる光が柔らかく広がる

#### 🌀 Arcane（秘術）
- **動作**: 渦巻き、エーテル状、次元的
- **色**: 紫（#aa88ff）
- **特徴**: 渦を巻くように動く神秘的なエネルギー

#### 🌿 Nature（自然）
- **動作**: 有機的な動き、滞留する雲
- **色**: 緑（#88ff44）
- **特徴**: 自然のエネルギーが漂う

### パーティクルスケーリング

#### Diabloモード（デフォルト）
- **パーティクル数**: 基本値 × 3.0
- **スキルレベル補正**: Lv.1で0.7倍、Lv.5で1.9倍
- **最大倍率**: 3.0 × 1.9 = **5.7倍**

**例：メテオ Lv.5**
- 基本: 75個
- Diabloモード適用後: 75 × 3.0 × 1.9 = **427個**

#### 低負荷モード
- **パーティクル数**: 基本値 × 0.55
- **MAX_PARTICLES**: 500個に制限
- 設定画面（Oキー）で切り替え可能

### スクリーンシェイク
全てのシェイク強度を**2倍**に強化：
- プレイヤー被ダメージ: 10px
- 通常攻撃: 8px
- 強攻撃: 12px
- 大技（メテオ等）: 16px

### パーティクル寿命
主要スキルのパーティクル寿命を**1.5倍**に延長：
- メテオ: 0.45～1.2秒
- フロストノヴァ: 0.6～0.9秒

---

## 実装状況

### ✅ 実装済み機能

#### コアシステム
- ✅ プレイヤー移動（慣性システム）
- ✅ 敵AI（追跡、攻撃）
- ✅ 衝突判定（8方向）
- ✅ ダンジョン生成
- ✅ 敵リスポーンシステム

#### スキルシステム
- ✅ スキルツリー（3ブランチ×複数スキル）
- ✅ スキルスロット編集（Rキー）
- ✅ スキル削除機能
- ✅ スキルツリーから直接設定
- ✅ 死亡時もスキル編集可能
- ✅ 数字キーで即時発動（自動ターゲット）
- ✅ 属性別エフェクトシステム（7属性）
- ✅ スキルレベル連動エフェクト

#### エフェクトシステム
- ✅ Diabloモード（パーティクル3倍）
- ✅ 属性別パーティクル動作（7種類）
- ✅ スキルレベルスケーリング（最大5.7倍）
- ✅ プロジェクタイルオーラリング
- ✅ スクリーンシェイク強化（2倍）

#### アイテムシステム
- ✅ レアリティシステム
- ✅ Affix生成
- ✅ インベントリ（24スロット）
- ✅ 装備変更
- ✅ 自動拾い機能

#### UI/UX
- ✅ HP/MPオーブ（Diablo風）
- ✅ スキルバー（6スロット）
- ✅ ステータス画面
- ✅ インベントリ画面
- ✅ スキルツリー画面
- ✅ ヘルプ画面（動的スキル表示）
- ✅ 設定画面
- ✅ スキルバッジシステム（習得済/解放済）
- ✅ 未使用スキルポイントバナー

#### セーブシステム
- ✅ 3つのセーブスロット
- ✅ オートセーブ（階層移動時）
- ✅ 手動セーブ（F5）

### 🚧 未実装・改善予定

#### グラフィック
- ❌ キャラクターアニメーション（歩行、攻撃）
- ❌ 敵アニメーション
- ❌ 攻撃エフェクト強化（スラッシュ軌跡）
- ❌ 動的ライティング
- ❌ ミニマップ
- ⚠️ ダメージフラッシュ（現在無効化）

#### ゲームプレイ
- ❌ ダッシュ/回避システム
- ❌ クラス昇格システム（実装途中）
- ❌ エンドコンテンツ

#### UI
- ❌ バフ/デバフ表示
- ❌ フローティングダメージ（改善）
- ❌ ボスHPバー

---

## 既知の問題

### 🐛 現在の問題

#### 敵グラフィック（調査中）
- **状態**: 敵スプライトの表示に問題がある可能性
- **対応**: alphaFlash（ダメージフラッシュ）を完全無効化
- **トレードオフ**: ダメージ時の視覚フィードバックが無くなった
- **今後**: 別のアプローチでダメージ表現を実装予定

#### エフェクトの派手さ（ユーザーフィードバック待ち）
- **現状**: Diabloモード（パーティクル3倍）実装済み
- **検証必要**: 実機でのFPSテスト（目標30+）
- **対策**: 低負荷モード提供済み

### ⚠️ 制限事項
- モバイル非対応（タッチ操作未実装）
- セーブデータ容量制限（localStorage: 5-10MB）
- ブラウザキャッシュ問題（強制リロード必要な場合あり）

---

## 改善予定

### 優先度：最高（緊急）
1. **敵グラフィック問題の根本解決**
   - 現在の状態を検証
   - 必要に応じて別のアプローチを試す
2. **エフェクトの視認性向上**
   - ユーザーフィードバックに基づいて調整
   - パフォーマンスとのバランスを取る

### 優先度：高
3. キャラクター歩行アニメーション
4. ダメージフィードバック再実装（別手法）
5. ミニマップ実装

### 優先度：中
6. 動的ライティング
7. ダッシュ/回避システム
8. バフ/デバフUI

### 優先度：低
9. モバイル対応
10. マルチプレイヤー要素
11. サウンドトラック追加

---

## 変更履歴

### v0.6.0 (2026-02-08) **現在のバージョン**

**主な変更**:
- ✅ **Diabloモード導入**: パーティクル数3倍（最大5.7倍）
- ✅ MAX_PARTICLES上限引き上げ（500 → 1500）
- ✅ 属性別エフェクトシステム（7属性）
- ✅ スクリーンシェイク2倍強化
- ✅ 数字キー即時発動（自動ターゲット）
- ✅ スキルスロット動的表示（ヘルプ画面）
- ✅ 昇格スキル完全一覧表示
- ✅ スキルバッジシステム（習得済/解放済）
- ✅ 未使用スキルポイントバナー
- ✅ パーティクル寿命延長（主要スキル1.5倍）

**エフェクト強化の詳細**:
- 火炎スキル: 上昇+ちらつき動作
- 氷スキル: 減速+回転、ダイヤ形状
- 雷スキル: ジグザグ+軌跡
- 物理スキル: 重力+バウンス
- メテオLv.5: 142個 → 427個（3倍）

**修正されたバグ**:
- ヘルプ画面のスキル説明がハードコード（動的生成に変更）
- 昇格先スキルが2個のみ表示（全スキル表示に変更）
- projectile_fireとmulti_shotの属性パラメータ固定

**緊急修正**:
- alphaFlash完全無効化（赤背景問題の対応）

**パフォーマンス影響**:
- 理論値: FPS約40%低下（60fps → 36fps on 低スペック）
- 対策: 低負荷モード提供、MAX_PARTICLES上限チェック

### v0.5.0 (2025-02-07)

**主な変更**:
- ✅ スキルスロット初期化を空に変更
- ✅ スキル削除機能追加
- ✅ スキルツリーから直接設定可能に
- ✅ 移動慣性調整（ハクスラ感強化）
- ✅ 敵出現数3倍に増加（15 + Floor*8）
- ✅ 敵の継続リスポーンシステム追加
- ✅ Rキーが死亡時も動作するよう修正
- ✅ Division by Zero バグ修正
- ✅ パーティクル上限設定（500個）

**修正されたバグ**:
- 重複keydownイベントリスナーによるRキー不動作
- 復活後に全キーが効かなくなる致命的バグ
- 未習得スキルがスロットに入るバグ

**レビュー体制**:
- Agent Team厳格レビュー体制を導入

### v0.4.0 (初期リリース)
- 基本的なゲームシステム実装
- プレイヤー移動、戦闘、スキル
- アイテム、ダンジョン生成

---

## 開発体制

本ゲームは **Agent Team 厳格レビュー体制** で開発されています。

詳細は [TEAM_SPEC.md](TEAM_SPEC.md) を参照してください。

### 開発チーム
- 🎯 リーダー（Claude）: 実装・Git操作
- 🎨 グラフィック担当: ビジュアルレビュー
- ⚙️ ロジック担当: ゲームロジックレビュー
- 🔍 テスト担当: 品質保証・最終承認
- 🐛 デバッグ専門: 根本原因特定

---

**End of Document**
