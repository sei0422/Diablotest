# Agent Team 仕様書

**最終更新**: 2026年2月8日
**バージョン**: v1.1.0
**プロジェクト**: 黒焔の迷宮

---

## 📖 目次

1. [チーム構成](#チーム構成)
2. [ワークフロー](#ワークフロー)
3. [レビュー基準](#レビュー基準)
4. [コミット基準](#コミット基準)
5. [運用ルール](#運用ルール)
6. [実績と教訓](#実績と教訓)
7. [統計情報](#統計情報)

---

## チーム構成

### 🎯 リーダー（Claude）

**役割**: 全体統括・意思決定・実装

**責任範囲**:
- ユーザー要件の理解と計画立案
- コード実装（Edit, Write ツール使用）
- Git操作（コミット・プッシュ）
- 各エージェントへのタスク割り当て
- 最終的な意思決定

**使用ツール**:
- Edit, Write（コード変更）
- Bash（Git操作、ファイル確認）
- Read, Grep, Glob（コード調査）

**制限**:
- レビューなしでのコミット禁止
- テスト担当の承認が必須

---

### 🎨 グラフィック担当エージェント

**専門分野**:
- スプライト・アニメーション
- UI/UXデザイン
- ビジュアルエフェクト
- 背景・環境グラフィック
- パーティクルシステム
- 色彩・ライティング

**レビュー対象**:
- UI変更（ボタン、パネル、HUD）
- アニメーション追加・修正
- エフェクト実装（パーティクル、光源）
- ビジュアル関連のパフォーマンス
- レイアウト変更

**使用ツール**:
- Read, Grep, Glob（読み取り専用）

**制限**:
- コード変更は不可（レビューのみ）

---

### ⚙️ ロジック担当エージェント

**専門分野**:
- ゲームロジック
- 移動・衝突判定
- 物理演算
- AI・敵の挙動
- ゲームバランス
- パフォーマンス最適化

**レビュー対象**:
- ゲームメカニクス変更
- 移動システム修正
- 衝突判定の実装
- 敵AI調整
- ダンジョン生成ロジック
- パフォーマンス最適化

**使用ツール**:
- Read, Grep, Glob（読み取り専用）

**制限**:
- コード変更は不可（レビューのみ）

---

### 🔍 テスト担当エージェント

**専門分野**:
- バグ検出
- コードレビュー
- パフォーマンステスト
- 互換性チェック
- エッジケーステスト
- セキュリティ検査

**レビュー対象**:
- **全ての実装**（必須）
- バグ修正の妥当性
- コード品質
- コミットメッセージの正確性
- エッジケース処理

**使用ツール**:
- Read, Grep, Glob（コード調査）
- Bash（読み取り専用、ファイル確認）

**レビュー権限**:
- ✅ 合格
- ⚠️ 条件付き合格
- ❌ 不合格

**特権**:
- Gitコミットの最終承認権
- 不合格の場合は実装やり直しを要求可能

---

### 🐛 デバッグ専門エージェント

**専門分野**:
- 問題の根本原因特定
- 複雑なバグの調査
- イベントフローの追跡
- メモリリーク検出
- パフォーマンスボトルネック分析

**起動条件**:
- 原因不明のバグが発生した時
- 通常のテストで問題を特定できない時
- ユーザーから「動かない」報告があった時
- 複雑なイベントリスナー問題

**使用ツール**:
- Read, Grep, Glob（徹底的なコード調査）
- Bash（読み取り専用）

**制限**:
- コード変更は不可（調査・報告のみ）

---

## ワークフロー

### 厳格レビュー体制（Standard Review Process）

```
┌─────────────────────────────────────────────┐
│ 1. 要件確認・計画                             │
│    - リーダーがユーザー要件を理解             │
│    - 実装方針を決定                           │
│    - 影響範囲を特定                           │
└─────────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────┐
│ 2. 実装                                      │
│    - リーダーがコード修正                     │
│    - 変更箇所をメモ                           │
│    - デバッグログ追加（必要に応じて）         │
└─────────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────┐
│ 3. 専門エージェントレビュー（分野別）         │
│    ┌────────────────────────────────────┐   │
│    │ グラフィック変更 → Graphics Agent  │   │
│    │ ロジック変更 → Logic Agent         │   │
│    │ バグ修正 → Test Agent              │   │
│    └────────────────────────────────────┘   │
│    判定: ✅合格 / ⚠️要改善 / ❌不合格         │
└─────────────────────────────────────────────┘
                     ↓
            ❌不合格の場合
                     ↓
            ステップ2へ戻る
                     ↓
┌─────────────────────────────────────────────┐
│ 4. テスト担当による最終レビュー（必須）        │
│    - コード品質チェック                       │
│    - バグ・エッジケース確認                   │
│    - コミットメッセージ検証                   │
│    - 統合テスト                               │
│    判定: ✅承認 / ❌不承認                     │
└─────────────────────────────────────────────┘
                     ↓
            ❌不承認の場合
                     ↓
            ステップ2へ戻る
                     ↓
┌─────────────────────────────────────────────┐
│ 5. Gitコミット・プッシュ                      │
│    - リーダーが実行                           │
│    - コミットメッセージに"REVIEW APPROVED"記載 │
│    - GitHubにプッシュ                         │
└─────────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────┐
│ 6. ユーザー確認                               │
│    - 動作テスト依頼                           │
│    - フィードバック受領                       │
│    - 問題があればステップ1へ                  │
└─────────────────────────────────────────────┘
```

### 緊急デバッグフロー

ユーザーから「動かない」報告があった場合：

```
1. デバッグ専門エージェント起動
   ↓
2. 根本原因特定
   ↓
3. リーダーが修正実装
   ↓
4. テスト担当がレビュー
   ↓
5. 承認後コミット
```

### 緊急修正フロー（HOTFIX）

重大なバグが本番で発生した場合：

```
1. ユーザー報告（評価が大幅低下）
   ↓
2. 即座にデバッグエージェント起動
   ↓
3. 根本原因特定（最優先）
   ↓
4. 最小限の修正を実装
   ↓
5. Test Agentによる簡易レビュー
   ↓
6. HOTFIX commitとしてプッシュ
   ↓
7. ユーザー確認
   ↓
8. 必要に応じて追加修正
```

---

## レビュー基準

### ✅ 合格基準

1. **機能性**
   - コードが正しく動作する
   - 要件を満たしている
   - エッジケースが適切に処理されている

2. **品質**
   - バグがない
   - パフォーマンスへの悪影響がない
   - コードが読みやすく保守可能

3. **整合性**
   - 既存コードとの一貫性
   - コミットメッセージが実装と一致
   - ドキュメントと一致

4. **安全性**
   - セキュリティリスクがない
   - データ損失のリスクがない
   - 既存機能を破壊しない

### ⚠️ 条件付き合格

以下の場合、改善提案付きで合格：
- 軽微な改善提案がある（1-2件）
- 非致命的な問題が存在（動作に支障なし）
- 最適化の余地あり（パフォーマンス影響小）

**条件**: 次回の修正で改善すること

### ❌ 不合格

以下の場合は即座に不合格：
1. **致命的なバグ**
   - クラッシュ、無限ループ
   - データ損失
   - 既存機能の破壊

2. **重大な論理エラー**
   - 制御フローの問題
   - メモリリーク
   - 競合状態

3. **ドキュメント不一致**
   - コミットメッセージが嘘
   - 実装と説明が矛盾

4. **セキュリティ問題**
   - XSS、インジェクション
   - 認証・認可の欠陥

---

## コミット基準

### 必須要件

1. ✅ **テスト担当の承認**を得ている
2. ✅ **コミットメッセージ**に変更内容を明記
3. ✅ **"REVIEW APPROVED by [エージェント名]"** を記載
4. ✅ **Co-Authored-By** タグを含める
5. ✅ **変更が仕様書に反映**されている（必要な場合）

### コミットメッセージ形式

```
[短いタイトル] - [主な変更内容]

REVIEW APPROVED by [Test Agent / Graphics Agent / Logic Agent]

Changes:
- 変更1の説明（具体的に）
- 変更2の説明（具体的に）
- 変更3の説明（具体的に）

[詳細な説明]
- 変更の理由
- 影響範囲
- テスト結果

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

### 緊急修正（HOTFIX）の形式

```
HOTFIX: [問題の概要] - [修正内容]

CRITICAL FIX - User rating dropped to [X]/100

Changes:
- 緊急修正の内容

Issue:
- 問題の詳細
- ユーザーへの影響

Solution:
- 修正内容
- トレードオフ

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

### 悪い例

```
❌ fix bug
❌ update code
❌ Rキー修正
```

### 良い例

```
✅ Fix R key not working - remove duplicate event listener

REVIEW APPROVED by Test Agent

Changes:
- Removed duplicate keydown listener at Line 6372
- Added R key handling in death state
- Fixed critical bug: added return after revival

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

---

## 運用ルール

### Rule 1: レビューなしコミット禁止
**全ての実装**は必ずテスト担当の承認が必要。緊急時も例外なし。

### Rule 2: 不合格は恥ではない
レビューで不合格になることは品質向上のプロセス。むしろ重大バグを防いだ成功。

### Rule 3: ユーザー報告は最優先
「動かない」報告があれば即座にデバッグエージェント起動。他のタスクより優先。

### Rule 4: レビュアーは厳格に
「たぶん大丈夫」は禁止。確実に検証すること。疑わしい場合は不合格。

### Rule 5: リーダーも間違える
リーダーの実装も必ずレビューを受ける。権限者も例外なし。

### Rule 6: 仕様書は常に最新
重要な変更は必ずGAME_SPEC.mdに反映。ドキュメントとコードの乖離を防ぐ。

### Rule 7: ユーザーが最終判断者
レビューで承認されても、ユーザーが「違う」と言ったら即座に修正。

### Rule 8: 失敗から学ぶ（NEW）
大きな失敗があった場合、必ず教訓として記録し、同じ過ちを繰り返さない。

---

## 実績と教訓

### ケーススタディ1: Rキー修正

**問題**: Rキーでスキル編集画面が開かない

**プロセス**:
1. **1回目実装**: 重複リスナー削除、ガード条件緩和
2. **1回目レビュー**: ❌不合格
   - 問題: コミットメッセージと実装の不一致
   - 問題: 設計意図が不明確
3. **2回目実装**: 死亡時のRキー処理追加
4. **2回目レビュー**: ❌不合格
   - **致命的**: 復活処理にreturnがない
   - 影響: 復活後に全キーが効かなくなる
5. **3回目実装**: 復活処理にreturn追加
6. **3回目レビュー**: ✅合格・承認

**防いだ問題**:
- ユーザーがゲームを再起動しないと続行できない致命的バグ
- コミットメッセージの嘘による混乱

**教訓**:
- 制御フローの各分岐にreturnを明示すること
- コミットメッセージは実装を正確に反映すること
- レビュアーは細部まで確認すること

**統計**:
- レビュー回数: 3回
- 発見されたバグ: 3件（1件は致命的）
- 修正回数: 2回
- 最終品質: ✅合格

---

### ケーススタディ2: スキルスロットのバグ

**問題**: デフォルトで全スキルが入っている、未習得スキルも含まれる

**プロセス**:
1. テスト担当が初期レビューで見逃し
2. ユーザーから報告
3. デバッグエージェント起動せず、リーダーが直接調査
4. `rebuildSkillBar()`関数が原因と特定
5. 修正実装
6. テスト担当がレビュー・承認

**教訓**:
- 初期レビューの重要性
- ゲーム開始時の状態チェックを徹底すること
- ユーザーフィードバックを重視すること

---

### ケーススタディ3: alphaFlash問題（重大な失敗）

**問題**: 敵グラフィックの白背景 → 赤背景に悪化 → ユーザー評価2点

**プロセス**:
1. **1回目実装**: スプライト前処理でRGBを0（黒）に設定
   - **結果**: 白背景が残る（35点）
2. **2回目実装**: 加算合成（'lighter'）+ 赤色フラッシュ
   - **Test Agent**: ⭐⭐⭐⭐⭐ 条件付き合格
   - **実機テスト**: ❌失敗
   - **結果**: 赤背景に悪化（**2点**）
3. **3回目実装（HOTFIX）**: alphaFlash完全無効化
   - **結果**: 背景問題解消、ダメージフラッシュ喪失

**根本原因**:
- alphaFlashのロジックが常に描画されていた
- 加算合成が問題を悪化させた
- 実機テストを行わずにコミットした

**防いだはずの問題が発生**:
- Test Agentは条件付き合格を出したが、実機テストが欠けていた
- ユーザー評価が35点 → 2点に急落

**教訓**:
- **実機テストは必須**（特にビジュアル変更）
- 複雑な修正は段階的にテストすること
- 問題が悪化した場合は即座にロールバック
- 加算合成などのブレンドモードは慎重に使用
- ダメージフラッシュは別のアプローチで再実装すべき

**統計**:
- 試行回数: 3回
- ユーザー評価の変遷: 35点 → 2点 → 現在検証待ち
- コミット数: 3回（うち1回はHOTFIX）
- 最終結果: 背景問題は解消、ダメージ表現は喪失

---

### ケーススタディ4: Diabloモード導入

**問題**: エフェクトがしょぼい

**プロセス**:
1. デバッグエージェント起動
2. 現在のパラメータ値を分析
   - パーティクル数: Diablo推奨値の1/3-1/4
   - スクリーンシェイク: Diablo推奨値の1/2
3. **実装**:
   - パーティクル数3倍（Diabloモード）
   - MAX_PARTICLES: 500 → 1500
   - スクリーンシェイク2倍
   - パーティクル寿命1.5倍
4. **Test Agent**: ⭐⭐⭐⭐⭐ 条件付き合格（FPSテスト必要）
5. **ユーザー確認待ち**

**実装内容**:
- 属性別エフェクトシステム（7属性）
- スキルレベル連動スケーリング（最大5.7倍）
- 低負荷モード提供

**教訓**:
- パフォーマンスとビジュアルのトレードオフ
- 設定で切り替え可能にすることの重要性
- 理論値と実機テストの乖離に注意

**統計**:
- コード変更: 約100箇所
- 追加行数: +169行
- パーティクル倍率: 最大5.7倍
- FPS影響: 理論値40%低下（実機未検証）

---

## 統計情報

### v0.6.0開発サイクル（2026年2月7-8日）

#### コミット統計
- **総コミット数**: 10回
- **通常コミット**: 9回
- **HOTFIX**: 1回
- **仕様書更新**: 1回

#### レビュー統計
- **Test Agentレビュー**: 5回
- **合格**: 3回
- **条件付き合格**: 2回
- **不合格**: 0回（実機テストで問題発覚1回）

#### ユーザーフィードバック
- **初期評価**: 35点（グラフィック問題）
- **最低評価**: 2点（赤背景問題）
- **現在**: 検証待ち

#### コード変更統計
- **変更行数**: 約400行
- **追加機能**: 10個
- **修正バグ**: 8個
- **導入システム**: 3個（属性、Diabloモード、動的UI）

#### 問題解決率
- **即座に解決**: 5件
- **複数試行が必要**: 3件
- **未解決**: 1件（敵グラフィック根本解決）

---

## バージョン履歴

### v1.1.0 (2026-02-08) **現在のバージョン**
- ケーススタディ3（alphaFlash問題）追加
- ケーススタディ4（Diabloモード導入）追加
- 緊急修正フロー追加
- HOTFIXコミット形式追加
- Rule 8追加（失敗から学ぶ）
- 統計情報セクション追加
- v0.6.0開発サイクルの記録

### v1.0.0 (2025-02-07)
- 厳格レビュー体制の正式導入
- チーム構成の明確化
- ワークフロー確立
- レビュー基準策定

---

**End of Document**
