# 黒焔の迷宮 — 仕様書 v2.0

## 概要

**タイトル**: 黒焔の迷宮 (Dungeon of Black Flame)
**ジャンル**: Diablo風 ハック＆スラッシュ ローグライクRPG
**形式**: 単一HTMLファイル (diablo_game.html / 約4,900行 / 約217KB)
**動作環境**: モダンブラウザ (Canvas 2D + Web Audio API)
**言語**: 日本語UI

---

## ディレクトリ構造

```
Diablotest/
├── diablo_game.html          … ゲーム本体 (HTML/CSS/JS 全包含)
├── SPEC.md                   … 本仕様書
│
└── asset/
    ├── 32rogues/                          … メインスプライトシート (使用中)
    │   ├── tiles.png          (544×832)   … 壁・床・階段・宝箱・血痕・棺など
    │   ├── monsters.png       (384×416)   … スケルトン・ゾンビ・インプ・ゴーストなど
    │   ├── rogues.png         (224×224)   … プレイヤーキャラ全クラス
    │   ├── items.png          (352×832)   … 武器・防具・ポーション・ゴールドなど
    │   ├── animated-tiles.png (352×384)   … 松明(アニメ6F)・火・水・灯りなど
    │   ├── animals.png                    … 動物スプライト
    │   ├── autotiles.png                  … 水・毒沼オートタイル
    │   ├── items-palette-swaps.png        … アイテム色違い
    │   ├── 32rogues-palette.png           … パレット参照
    │   ├── LICENSE.txt                    … ライセンス (商用OK, NFT/AI禁止)
    │   └── *.txt                          … 各シートの内容説明
    │
    └── 2D Pixel Dungeon Asset Pack/       … 追加アセット (未統合)
        ├── Character_animation/           … skeleton, skull, vampire, priest アニメ
        ├── items and trap_animation/      … chest, coin, flasks, keys, torch, 罠
        ├── interface/                     … 矢印・UIパーツ
        ├── character and tileset/         … タイルセット・キャラシート
        └── Dungeon_*.png                  … アトラス画像
```

---

## コア仕様

### マップ・ダンジョン

- タイルサイズ: 40×40px (ゲーム内), スプライト元画像: 32×32px
- マップサイズ: 60×60タイル (2400×2400px)
- タイル種別: 壁(0) / 床(1) / 階段(2) / 宝箱(3)
- ダンジョン自動生成: BSP風ルーム配置 + 廊下接続
- 階層: 無限 (5階ごとにボス出現)
- 視界・探索済みマップシステム

### モンスター出現テーブル

| 階層 | 出現モンスター |
|------|----------------|
| B1F〜B2F | スケルトン、ゾンビ |
| B3F〜B4F | スケルトン、ゾンビ、インプ |
| B5F〜B6F | ゾンビ、インプ、ゴースト |
| B7F〜 | インプ、ゴースト |
| 5の倍数階 | +デーモンロード (ボス) |

出現数: `5 + 階層 × 3` 体 / 階層倍率: `1 + (floor - 1) × 0.3`

### モンスターステータス (基礎値)

| モンスター | HP | DMG | SPD | XP | ドロップ率 | スプライト |
|---|---|---|---|---|---|---|
| スケルトン | 40 | 8 | 60 | 25 | 40% | skeleton |
| ゾンビ | 70 | 12 | 40 | 35 | 45% | zombie |
| インプ | 30 | 15 | 100 | 45 | 50% | imp |
| ゴースト | 25 | 10 | 110 | 55 | 55% | banshee |
| デーモンロード | 300 | 30 | 70 | 300 | 100% | deathKnight |

---

## クラスチェンジシステム

### 概要
- **2段階クラスシステム**: Tier 0 (基本クラス) → Tier 1 (上位クラス)
- **クラスチェンジ条件**: レベル10到達時に自動発動
- **選択**: 基本クラスごとに2つの上位クラスから選択
- **引き継ぎ**: 基本クラスの習得済みスキルは全て使用可能

### クラスツリー

```
戦士 (WARRIOR) ─┬─→ 聖騎士 (PALADIN)  … 聖光・防御・回復の騎士
                └─→ 狂戦士 (BERSERKER) … 怒りと破壊の近接火力

盗賊 (ROGUE) ──┬─→ 暗殺者 (ASSASSIN)  … 単体高火力・毒・隠密
               └─→ 狩人 (RANGER)      … 遠距離射撃・罠・制圧

魔法使い (SORCERER) ─┬─→ 炎術師 (PYROMANCER) … 炎と爆発の範囲殲滅
                     └─→ 氷術師 (CRYOMANCER) … 凍結とCC特化
```

---

## 基本クラス詳細 (Tier 0)

### 戦士 (Warrior)
- **ステ**: STR 20 / DEX 10 / VIT 20 / INT 5
- **スプライト**: knight

| ブランチ | スキル1 | スキル2 | スキル3 |
|---|---|---|---|
| **戦技** | 💥 パワーストライク | 🌀 旋風斬 | 👹 狂戦士 |
| **防御** | 📯 雄叫び | 🛡 鉄壁 | ⚡ 突撃 |
| **闘気** | 🔥 不屈の闘志 | 💢 地裂撃 | ⚔ 見切り |

### 盗賊 (Rogue)
- **ステ**: STR 10 / DEX 20 / VIT 15 / INT 10
- **スプライト**: rogueChar

| ブランチ | スキル1 | スキル2 | スキル3 |
|---|---|---|---|
| **射撃** | 🔥 炎の矢 | 🌟 マルチショット | 🌧 矢の雨 |
| **暗殺** | 💣 トラップ | 💨 回避 | 🗡 影撃ち |
| **俊敏** | 💫 疾風歩 | ☠ 毒塗り | 🌫 煙幕 |

### 魔法使い (Sorcerer)
- **ステ**: STR 5 / DEX 10 / VIT 10 / INT 25
- **スプライト**: wizardM

| ブランチ | スキル1 | スキル2 | スキル3 |
|---|---|---|---|
| **元素魔法** | 🔥 ファイアボルト | ⚡ チェインライトニング | ☄ メテオ |
| **秘術** | ❄ フロストノヴァ | ✨ テレポート | 🔷 マナシールド |
| **呪詛** | 💜 マナドレイン | ⛓ 呪縛 | 🌑 暗黒球 |

---

## 上位クラス詳細 (Tier 1)

### 聖騎士 (Paladin) ← 戦士
- **ステ**: STR 22 / DEX 10 / VIT 25 / INT 8
- **スプライト**: paladin (shield knight)
- **特徴**: 聖なる力で攻守兼備。回復とオーラ持ち。

| ブランチ | スキル1 | スキル2 | スキル3 |
|---|---|---|---|
| **聖光** | ✝ ホーリースマイト | ⚖ 裁き | 🌟 神罰 |
| **神盾** | 🛡 聖盾 | 💚 聖なる癒し | 💛 守護のオーラ |
| **聖戦** | ☀ 聖域 | 🗡 聖なる情熱 | ⚔ 天撃 |

### 狂戦士 (Berserker) ← 戦士
- **ステ**: STR 28 / DEX 12 / VIT 18 / INT 3
- **スプライト**: berserker (male barbarian)
- **特徴**: 圧倒的な近接火力。ライフスティールと不死身。

| ブランチ | スキル1 | スキル2 | スキル3 |
|---|---|---|---|
| **猛攻** | 🪓 クリーヴ | 😤 フレンジー | 💀 処刑 |
| **血気** | 🔴 怒髪天 | 🩸 血の刃 | 💪 不死身 |
| **破壊** | 🦘 リープアタック | 💥 衝撃波 | 🌋 暴走 |

### 暗殺者 (Assassin) ← 盗賊
- **ステ**: STR 14 / DEX 26 / VIT 12 / INT 12
- **スプライト**: assassin (bandit)
- **特徴**: 影から一撃必殺。毒と回避のスペシャリスト。

| ブランチ | スキル1 | スキル2 | スキル3 |
|---|---|---|---|
| **刃の舞** | 🗡 バックスタブ | ⚔ 乱れ撃ち | 💀 死の刻印 |
| **毒術** | ☠ 猛毒の刃 | 🌫 毒霧 | 💚 猛毒爆発 |
| **影歩** | 💨 瞬歩 | 👥 影分身 | 🌑 消失 |

### 狩人 (Ranger) ← 盗賊
- **ステ**: STR 12 / DEX 24 / VIT 16 / INT 12
- **スプライト**: rangerCls (ranger)
- **特徴**: 遠距離の精密射撃と罠で戦場を制圧。

| ブランチ | スキル1 | スキル2 | スキル3 |
|---|---|---|---|
| **猟弓** | 🏹 貫通矢 | 🌟 速射 | 🎯 狙撃 |
| **罠術** | 💣 爆裂トラップ | 🕸 捕獲網 | 💥 地雷原 |
| **野生** | 🦅 鷹の目 | 🍃 追い風 | 🌧 天矢の雨 |

### 炎術師 (Pyromancer) ← 魔法使い
- **ステ**: STR 5 / DEX 10 / VIT 12 / INT 30
- **スプライト**: pyromancer (female wizard)
- **特徴**: 炎と爆発で全てを焼き尽くす。最高の範囲火力。

| ブランチ | スキル1 | スキル2 | スキル3 |
|---|---|---|---|
| **火炎** | 🔥 ファイアボール | 🧱 ファイアウォール | 🌋 インフェルノ |
| **燃焼** | 🕯 イグニッション | 💥 爆炎 | 🦅 不死鳥の炎 |
| **爆発** | 💣 ファイアブラスト | 🔗 炎の連鎖 | ☄ メテオストーム |

### 氷術師 (Cryomancer) ← 魔法使い
- **ステ**: STR 5 / DEX 12 / VIT 14 / INT 28
- **スプライト**: cryomancer (druid)
- **特徴**: 凍結とCCで敵を完封する制御型魔法使い。

| ブランチ | スキル1 | スキル2 | スキル3 |
|---|---|---|---|
| **凍結** | 🔷 アイスランス | ❄ フロストノヴァ | 🌠 アイスコメット |
| **氷壁** | 🛡 アイスアーマー | 🪞 氷鏡 | 🔒 氷牢 |
| **吹雪** | 🌨 ブリザード | 🥶 絶対零度 | 💎 氷砕 |

---

## スキルシステム

### スキル構成
- 基本クラス: 3ブランチ × 3スキル = **9スキル**
- 上位クラス: さらに3ブランチ × 3スキル = **9スキル** (基本クラスのスキルも使用可)
- 合計最大: **18スキル** (基本9 + 上位9)

### スキルバー
- **6スロット** のアクティブスキルバー
- **Rキー** でスキルセット編集画面を開く
- 習得済みスキルの中から自由に6つ選んでセット可能
- スロットをクリック → 使いたいスキルを選択

### スキルレベル
- 各スキル最大 **Lv.3**
- レベルアップ時にスキルポイント獲得
- スキルツリー (Tキー) でポイント振り分け
- 上位スキルは前提スキル習得が必要

### 新規バフ/デバフ一覧

| 効果 | 説明 |
|---|---|
| 見切り (counterT) | 被弾時に自動反撃 |
| 疾風 (speedBuffT) | 移動速度上昇 |
| 毒塗り (poisonBuffT) | 攻撃に毒付与 |
| 攻速UP (atkSpdBuffT) | 攻撃速度上昇 |
| 血の刃 (lifestealBuffT) | ライフスティール付与 |
| 不死身 (undyingT) | HP0で死亡せず1で耐える |
| 消失 (stealthT) | 姿を消し次攻撃クリ確定 |
| 鷹の目 (critBuffT) | クリティカル率大幅上昇 |
| 守護のオーラ (auraT) | HP自動回復 + 被ダメ減 |
| 呪縛 (cursedT) | 敵の被ダメージ増加 |
| 聖域 (consecrate) | 範囲持続ダメージフィールド |
| 貫通 (pierce) | 飛翔体が敵を貫通 |

---

## アイテムシステム

### 装備タイプ

| キー | 名前 | スロット | 基礎値 | スプライト |
|------|------|----------|--------|-----------|
| sword | 剣 | weapon | DMG 5-12 | iSword |
| axe | 戦斧 | weapon | DMG 8-16 | iAxe |
| staff | 杖 | weapon | DMG 3-8 | iStaff |
| shield | 盾 | offhand | DEF 3-8 | iShield |
| helmet | 兜 | head | DEF 2-5 | iHelmet |
| armor | 鎧 | body | DEF 4-10 | iArmor |
| ring | 指輪 | ring | DEF 0-1 | iRing |
| amulet | 護符 | amulet | DEF 0-1 | iAmulet |
| boots | 靴 | feet | DEF 1-4 | iBoots |
| potion | 回復薬 | — | HP+50 | iPotion |

### レアリティ

| レアリティ | 色 | アフィックス数 | 倍率 |
|---|---|---|---|
| コモン | #cccccc | 0 | ×1.0 |
| マジック | #6688ff | 1〜2 | ×1.3 |
| レア | #ffdd44 | 2〜3 | ×1.6 |
| レジェンダリー | #ff8800 | 3〜4 | ×2.0 |
| ユニーク | #00dd66 | 4〜5 | ×2.5 |

ドロップ確率: コモン50% / マジック28% / レア15% / レジェンダリー6% / ユニーク1%

### アフィックス一覧
筋力, 敏捷, 体力, 知力, ダメージ%, HP, MP, ライフスティール, 攻撃速度, 防御, クリティカル, 移動速度

---

## 操作方法

| キー | 機能 |
|------|------|
| 矢印キー / マウスクリック | 移動 |
| A | 最寄りの敵を攻撃 |
| S | 選択中スキル使用 |
| 1〜6 | スキルスロット選択 |
| Space | アイテム拾い |
| C | ステータスパネル開閉 |
| I | インベントリ開閉 |
| T | スキルツリー開閉 |
| **R** | **スキルセット編集** (NEW) |
| H | ヘルプ表示 |
| Enter/Space | タイトル画面進行 / 死亡時復活 |

※ IME対応のため `e.code` でキー判定 (日本語入力中でも動作)

---

## テクニカルアーキテクチャ

### スプライトシステム
- 5枚のPNGスプライトシート (tiles, monsters, rogues, items, animTiles)
- `ATLAS` オブジェクト: 基本タイル + 上位クラス用スプライト含む全マッピング
- `drawSpr()` ヘルパー: 32→40pxスケーリング + 水平反転 + nearest-neighbor補間
- `_drawGenericSprite()`: 全クラス共通の描画メソッド（クラスキーから自動でスプライト選択）
- 上位クラスはオーラエフェクト付き (クラスごとに色が異なる)

### クラスチェンジシステム
- `CLASS_DEFS`: 9クラス分の完全な定義 (3基本 + 6上位)
- `CLASS_PROMOTIONS`: 基本クラスごとの昇格選択肢
- `checkPromotion()`: レベルアップ時に自動チェック
- `showPromotionUI()`: 昇格選択オーバーレイ表示
- `getAllAvailableSkills()`: 基本+上位クラスの全スキル取得
- `rebuildSkillBar()`: スキルバーの自動再構築

### レンダリングパイプライン
1. キャンバスクリア → タイルマップ → 松明アニメ → 血だまり
2. 地上アイテム → モンスター → プレイヤー → 飛翔体
3. パーティクル → ライティング → フロートテキスト
4. フィルムグレイン → HUD → UIパネル

### オーディオシステム
- Web Audio API プロシージャル音声
- リバーブ (2.2秒カテドラル風) + BGM (オシレータ合成)
- 新スキル用SFX追加

### パフォーマンス最適化
- フィルムグレイン: プリレンダキャンバスオーバーレイ
- パーティクル: 単純円描画 / アンビエント15個
- タイルテクスチャ: オフスクリーンキャンバスにプリレンダ

---

## 未統合アセット

`2D Pixel Dungeon Asset Pack/` は現在未使用。利用可能リソース:
- モンスターアイドルアニメ (skeleton, skull, vampire)
- 聖職者アイドルアニメ (priest 3種)
- アイテム/罠アニメ (chest, coin, flask, key, trap)
- 松明/燭台アニメ
- UIパーツ / タイルセット
